---
name: æ™ºèƒ½æŸ¥è¯¢ç³»ç»Ÿè®¾è®¡è§„åˆ’
overview: åŸºäº PRD æ–‡æ¡£ï¼Œè®¾è®¡æ™ºèƒ½æŸ¥è¯¢ç³»ç»Ÿçš„å®Œæ•´é¡¹ç›®ç»“æ„ã€æ¨¡å—åˆ’åˆ†ã€æ ¸å¿ƒæ•°æ®æµå’Œåˆ†é˜¶æ®µå®æ–½è®¡åˆ’ã€‚é‡‡ç”¨ PostgreSQL æ¼”ç¤ºæ•°æ®åº“ï¼ˆç”µå•†åœºæ™¯ï¼‰ã€OpenAI å…¼å®¹ APIï¼ˆgpt-5.2-chat via yunwu.ai ä¸­è½¬ï¼‰ã€ChromaDB å†…ç½® Embeddingã€‚
todos:
  - id: p1-backend-scaffold
    content: "Phase 1.1: åç«¯è„šæ‰‹æ¶ â€” åˆå§‹åŒ– FastAPI é¡¹ç›®ç»“æ„ã€requirements.txtã€config.pyã€main.py (CORS+è·¯ç”±)ã€health æ¥å£"
    status: completed
  - id: p1-frontend-scaffold
    content: "Phase 1.2: å‰ç«¯è„šæ‰‹æ¶ â€” åˆå§‹åŒ– React (Vite) + TypeScript é¡¹ç›®ã€å®‰è£… Tailwind/ECharts ç­‰ä¾èµ–ã€ç©ºå£³ App.tsx"
    status: completed
  - id: p1-database-docker
    content: "Phase 1.3: æ•°æ®åº“ä¸å®¹å™¨åŒ– â€” ç¼–å†™ init.sql ç”µå•†æ¼”ç¤ºæ•°æ®ã€docker-compose.yml (PG)ã€.env.example"
    status: completed
  - id: p1-run-test
    content: "Phase 1.4: éªŒè¯è¿è¡Œ â€” åç«¯ uvicorn å¯åŠ¨ + GET /health è¿”å› 200ï¼›å‰ç«¯ npm run dev é¡µé¢å¯è®¿é—®ï¼›PG å®¹å™¨å¯åŠ¨å¯è¿æ¥"
    status: completed
  - id: p2-layout
    content: "Phase 2.1: å‰ç«¯å¸ƒå±€æ¡†æ¶ â€” Header (YIWUSONG Logo + æ ‡é¢˜ + çŠ¶æ€ç¯ + è¿”å›é¦–é¡µ) + Sidebar (æŸ¥è¯¢å†å²) + MainContent å·¦å³åˆ†æ å¸ƒå±€"
    status: completed
  - id: p2-query-input
    content: "Phase 2.2: QueryInput ç»„ä»¶ â€” åº•éƒ¨å›ºå®šè¾“å…¥æ¡†ã€Enter å‘é€ã€Shift+Enter æ¢è¡Œã€ç¦ç”¨æ€ã€æ¨èé—®é¢˜"
    status: completed
  - id: p2-result-panel
    content: "Phase 2.3: ç»“æœå±•ç¤ºç»„ä»¶ â€” ThinkingDisplay (æ‰“å­—æœºæ•ˆæœ) + SqlPreview (è¯­æ³•é«˜äº®+å¤åˆ¶) + DataTable (æŸ¥è¯¢ç»“æœè¡¨æ ¼) + EChartsRenderer (å£°æ˜å¼æ¸²æŸ“) + ErrorDisplay"
    status: completed
  - id: p2-sse-hook
    content: "Phase 2.4: SSE Hook + çŠ¶æ€æµè½¬ â€” useSSE.ts (fetch+ReadableStream)ã€UI çŠ¶æ€æœº (Idleâ†’Thinkingâ†’ShowSQLâ†’ShowChart)ã€éª¨æ¶å±"
    status: completed
  - id: p2-responsive-theme
    content: "Phase 2.5: å“åº”å¼ + ä¸»é¢˜ â€” ä¸‰æ¡£æ–­ç‚¹é€‚é…ã€æ·±è‰²ä¸»é¢˜ã€åŠ¨æ•ˆè¿‡æ¸¡"
    status: completed
  - id: p3-schema-rag
    content: "Phase 3.1: Schema RAG æ¥å£ â€” schema_extractor (PGå…ƒæ•°æ®æå–+æ³¨é‡Š+å¤–é”®) + embedder (ChromaDB å†…ç½® all-MiniLM-L6-v2) + retriever (è¯­ä¹‰ Top-K)"
    status: completed
  - id: p3-llm-engine
    content: "Phase 3.2: LLM Engine æ¥å£ â€” OpenAI å…¼å®¹ API è°ƒç”¨ (gpt-5.2-chat via yunwu.ai)ã€æµå¼è¾“å‡ºã€JSON ç»“æ„åŒ–è§£æï¼ˆæ”¯æŒ ```json ä»£ç å—æå–ï¼‰"
    status: completed
  - id: p3-security
    content: "Phase 3.3: å®‰å…¨å±‚æ¥å£ â€” SQL é˜²ç«å¢™ (sqlglot AST æ ¡éªŒ, 12 é¡¹ pytest å…¨é€šè¿‡) + query_limiter (è‡ªåŠ¨LIMIT+è¶…æ—¶+é€Ÿç‡é™åˆ¶) + åªè¯»è¿æ¥æ± "
    status: completed
  - id: p3-query-api
    content: "Phase 3.4: æ ¸å¿ƒæŸ¥è¯¢æ¥å£ â€” POST /api/query SSE + çŠ¶æ€æœº (SchemaRetrievalâ†’LLMGenerationâ†’SQLValidationâ†’SQLExecutionâ†’ResultStreaming) + POST /api/query/mock (4åœºæ™¯æ™ºèƒ½åŒ¹é…)"
    status: completed
  - id: p3-schema-api
    content: "Phase 3.5: Schema ç®¡ç†æ¥å£ â€” GET /api/schema/status + POST /api/schema/refresh + GET /api/schema/tables"
    status: completed
  - id: p4-integration
    content: "Phase 4.1: å‰åç«¯è”è°ƒ â€” SSE Hook å¯¹æ¥åç«¯å…¨éƒ¨äº‹ä»¶ç±»å‹ (state/thought/sql/data/viz_config/error/done)ã€DB å¥åº·æ£€æµ‹è‡ªåŠ¨é™çº§åˆ° Mock"
    status: completed
  - id: p4-e2e-test
    content: "Phase 4.2: ç«¯åˆ°ç«¯æµ‹è¯• â€” å‰ç«¯ä»£ç†éªŒè¯ã€Mock SSE å…¨æµç¨‹ã€curl ç‹¬ç«‹æµ‹è¯•"
    status: completed
  - id: p4-polish
    content: "Phase 4.3: ä¼˜åŒ–æ”¶å°¾ â€” Docker Compose ä¸‰æœåŠ¡ç¼–æ’ (postgres/backend/frontend)ã€Dockerfileã€nginx SSE ä»£ç†ã€Header è¿”å›é¦–é¡µ"
    status: completed
isProject: false
---

# æ¾å“¥çš„æ™ºèƒ½æ•°æ®åˆ†æç³»ç»Ÿ â€” é¡¹ç›®è®¾è®¡è§„åˆ’

## ä¸€ã€å…³é”®å†³ç­–ä¸å‡è®¾

- **ä¸šåŠ¡æ•°æ®åº“**: PostgreSQL 16ï¼Œå†…ç½®ç”µå•†æ¼”ç¤ºæ•°æ®é›†ï¼ˆ5 å¼ è¡¨ï¼šcategories / users / products / orders / order_itemsï¼‰ï¼Œå«å®Œæ•´ä¸­æ–‡å­—æ®µæ³¨é‡Š + å¤–é”®å…³ç³»
- **LLM æ¨¡å‹**: `gpt-5.2-chat`ï¼Œé€šè¿‡ yunwu.ai ä¸­è½¬ï¼ˆOpenAI å…¼å®¹ APIï¼‰ï¼ŒBase URL: `https://yunwu.ai/v1`
- **Embedding**: ChromaDB å†…ç½®é»˜è®¤ Embedding Functionï¼ˆall-MiniLM-L6-v2ï¼‰ï¼Œæ— éœ€é¢å¤–é…ç½®
- **å‘é‡æ•°æ®åº“**: ChromaDBï¼ˆæŒä¹…åŒ–å­˜å‚¨ï¼Œå¯åŠ¨æ—¶è‡ªåŠ¨æ„å»º Schema ç´¢å¼•ï¼‰
- **éƒ¨ç½²æ–¹å¼**: Docker Compose ä¸€é”®å¯åŠ¨ï¼ˆpostgres + backend + frontend/nginxï¼‰
- **é™çº§ç­–ç•¥**: æ•°æ®åº“ä¸å¯ç”¨æ—¶è‡ªåŠ¨é™çº§åˆ°åç«¯ Mock æ¨¡å¼ï¼ˆ4 ç§åœºæ™¯æ™ºèƒ½åŒ¹é…ï¼‰

---

## äºŒã€é¡¹ç›®ç›®å½•ç»“æ„

```
project-0211-IntelligentQuerySystem/
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ PRD.md                          # éœ€æ±‚æ–‡æ¡£
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ Dockerfile                      # Python 3.11 å®¹å™¨æ„å»º
â”‚   â”œâ”€â”€ requirements.txt                # Python ä¾èµ–
â”‚   â”œâ”€â”€ .env                            # æœ¬åœ°ç¯å¢ƒå˜é‡ï¼ˆå·² gitignoreï¼‰
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ main.py                     # FastAPI å…¥å£ + lifespan (DBåˆå§‹åŒ–+Schemaç´¢å¼•)
â”‚   â”‚   â”œâ”€â”€ config.py                   # å…¨å±€é…ç½® (Pydantic Settings)
â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ query.py            # POST /api/query (çœŸå®) + POST /api/query/mock (4åœºæ™¯)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ health.py           # GET /health (å« DB + ChromaDB çŠ¶æ€æ£€æµ‹)
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ schema.py           # Schema ç®¡ç† (status / refresh / tables)
â”‚   â”‚   â”‚   â””â”€â”€ deps.py                 # ä¾èµ–æ³¨å…¥
â”‚   â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ llm_engine.py           # OpenAI å…¼å®¹ API æµå¼è°ƒç”¨ + JSON ç»“æ„åŒ–è§£æ
â”‚   â”‚   â”‚   â”œâ”€â”€ state_machine.py        # æŸ¥è¯¢çŠ¶æ€æœº (5 é˜¶æ®µ + é‡è¯• + ECharts æ•°æ®å¡«å……)
â”‚   â”‚   â”‚   â””â”€â”€ prompt_templates.py     # System Prompt æ¨¡æ¿ (å«è¾“å‡ºæ ¼å¼çº¦æŸ)
â”‚   â”‚   â”œâ”€â”€ rag/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ schema_extractor.py     # ä» PG information_schema æå– DDL + æ³¨é‡Š + å¤–é”®
â”‚   â”‚   â”‚   â”œâ”€â”€ embedder.py             # ChromaDB å‘é‡åŒ– + ç´¢å¼•ç®¡ç† (upsert/reset)
â”‚   â”‚   â”‚   â””â”€â”€ retriever.py            # è¯­ä¹‰æ£€ç´¢ Top-K + æ‹¼æ¥ä¸º LLM context
â”‚   â”‚   â”œâ”€â”€ security/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ sql_firewall.py         # sqlglot AST æ ¡éªŒ (SELECT-only + è‡ªåŠ¨ LIMIT + å±é™©å‡½æ•°æ‹¦æˆª)
â”‚   â”‚   â”‚   â””â”€â”€ query_limiter.py        # æŸ¥è¯¢è¶…æ—¶ + æ»‘åŠ¨çª—å£é€Ÿç‡é™åˆ¶
â”‚   â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ database.py             # å¼‚æ­¥è¿æ¥æ±  (åªè¯»äº‹åŠ¡ + init/close ç”Ÿå‘½å‘¨æœŸ)
â”‚   â”‚   â”‚   â”œâ”€â”€ connection.py           # è¿æ¥é…ç½®
â”‚   â”‚   â”‚   â””â”€â”€ executor.py             # SQL æ‰§è¡Œ + ç»“æœåºåˆ—åŒ– (Decimal/datetimeâ†’JSON)
â”‚   â”‚   â””â”€â”€ models/
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â””â”€â”€ schemas.py              # Pydantic æ•°æ®æ¨¡å‹
â”‚   â””â”€â”€ tests/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ test_health.py              # å¥åº·æ£€æŸ¥æµ‹è¯•
â”‚       â””â”€â”€ test_sql_firewall.py        # SQL é˜²ç«å¢™ 12 é¡¹æµ‹è¯•
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ Dockerfile                      # Node æ„å»º + nginx é™æ€æœåŠ¡
â”‚   â”œâ”€â”€ nginx.conf                      # SPA è·¯ç”± + API åä»£ + SSE æ”¯æŒ
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ vite.config.ts                  # Vite é…ç½® (React + Tailwind + ä»£ç†)
â”‚   â”œâ”€â”€ tsconfig.json
â”‚   â”œâ”€â”€ index.html
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ main.tsx                    # React å…¥å£
â”‚       â”œâ”€â”€ App.tsx                     # ä¸»å¸ƒå±€ (DBå¥åº·è½®è¯¢ + çŠ¶æ€ç®¡ç†)
â”‚       â”œâ”€â”€ components/
â”‚       â”‚   â”œâ”€â”€ Header.tsx              # é¡¶éƒ¨å¯¼èˆª (Logo/æ ‡é¢˜å¯ç‚¹å‡»è¿”å›é¦–é¡µ + DBçŠ¶æ€ç¯)
â”‚       â”‚   â”œâ”€â”€ Sidebar.tsx             # å·¦ä¾§æŸ¥è¯¢å†å²
â”‚       â”‚   â”œâ”€â”€ QueryInput.tsx          # åº•éƒ¨è¾“å…¥æ¡† + æ¨èé—®é¢˜
â”‚       â”‚   â”œâ”€â”€ ThinkingDisplay.tsx     # æ€è€ƒè¿‡ç¨‹ (æ‰“å­—æœº + æŠ˜å )
â”‚       â”‚   â”œâ”€â”€ SqlPreview.tsx          # SQL è¯­æ³•é«˜äº® + å¤åˆ¶
â”‚       â”‚   â”œâ”€â”€ DataTable.tsx           # æŸ¥è¯¢ç»“æœæ•°æ®è¡¨æ ¼ (è¡Œæ•°/è€—æ—¶/æŠ˜å /äº¤æ›¿è¡Œ)
â”‚       â”‚   â”œâ”€â”€ EChartsRenderer.tsx     # é€šç”¨å›¾è¡¨ç»„ä»¶ (é€ä¼  option + ResizeObserver)
â”‚       â”‚   â”œâ”€â”€ ErrorDisplay.tsx        # é”™è¯¯æç¤º
â”‚       â”‚   â””â”€â”€ Skeleton.tsx            # éª¨æ¶å± (thinking/sql/chart)
â”‚       â”œâ”€â”€ hooks/
â”‚       â”‚   â””â”€â”€ useSSE.ts              # SSE Hook (çœŸå®é“¾è·¯ + DBå¥åº·æ£€æµ‹è‡ªåŠ¨é™çº§ + Mock)
â”‚       â”œâ”€â”€ services/
â”‚       â”‚   â””â”€â”€ api.ts                 # API å°è£… (query/health/schema)
â”‚       â””â”€â”€ types/
â”‚           â””â”€â”€ index.ts               # TypeScript ç±»å‹ (7ç§SSEäº‹ä»¶ + æŸ¥è¯¢ç»“æœæ•°æ®)
â”œâ”€â”€ database/
â”‚   â””â”€â”€ init.sql                       # æ¼”ç¤ºæ•°æ®åº“åˆå§‹åŒ– (5è¡¨ + ä¸‡æ¡æ•°æ® + åªè¯»ç”¨æˆ·)
â”œâ”€â”€ docker-compose.yml                 # ä¸‰æœåŠ¡ç¼–æ’ (postgres + backend + frontend)
â”œâ”€â”€ .env.example                       # ç¯å¢ƒå˜é‡æ¨¡æ¿
â”œâ”€â”€ .gitignore
â””â”€â”€ README.md
```

---

## ä¸‰ã€æ ¸å¿ƒæ¶æ„ä¸æ•°æ®æµ

### 3.1 è¯·æ±‚å…¨é“¾è·¯æ—¶åº

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·æµè§ˆå™¨
    participant FE as Reactå‰ç«¯
    participant BE as FastAPIåç«¯
    participant SM as çŠ¶æ€æœº
    participant RAG as Schema_RAG
    participant LLM as gpt-5.2-chat
    participant FW as SQLé˜²ç«å¢™
    participant DB as PostgreSQL

    User->>FE: è¾“å…¥è‡ªç„¶è¯­è¨€é—®é¢˜
    FE->>FE: æ£€æŸ¥ /health (DBçŠ¶æ€)
    alt DB å¯ç”¨
        FE->>BE: POST /api/query (SSE)
    else DB ä¸å¯ç”¨
        FE->>BE: POST /api/query/mock (é™çº§)
    end
    BE->>RAG: è¯­ä¹‰æ£€ç´¢ç›¸å…³Schema
    RAG-->>BE: Top-Kè¡¨ç»“æ„
    BE->>SM: åˆå§‹åŒ–çŠ¶æ€æœº
    SM->>LLM: System Prompt + Schema + ç”¨æˆ·é—®é¢˜
    LLM-->>SM: stream: thinking (é€ token)
    SM-->>BE: event:thought (delta)
    BE-->>FE: SSE event:thought
    LLM-->>SM: å®Œæ•´ JSON (thinking + sql + echarts_option)
    SM-->>BE: event:thought (done)
    SM->>FW: SQL ASTæ ¡éªŒ + è‡ªåŠ¨ LIMIT
    alt æ ¡éªŒé€šè¿‡
        FW-->>SM: PASS (å®‰å…¨SQL)
        SM-->>BE: event:sql
        BE-->>FE: SSE event:sql
        BE->>DB: æ‰§è¡Œåªè¯»SQL (å¸¦è¶…æ—¶)
        DB-->>BE: æŸ¥è¯¢ç»“æœ
        SM-->>BE: event:data (åˆ—å+è¡Œæ•°æ®+è€—æ—¶)
        BE-->>FE: SSE event:data
        SM-->>BE: event:viz_config (ç”¨å®é™…æ•°æ®å¡«å…… ECharts option)
        BE-->>FE: SSE event:viz_config
    else æ ¡éªŒå¤±è´¥ä¸”é‡è¯•<3æ¬¡
        FW-->>SM: REJECT + åŸå› 
        SM->>LLM: ä¿®æ­£è¯·æ±‚
    else è¶…è¿‡é‡è¯•æ¬¡æ•°
        SM-->>BE: event:error
        BE-->>FE: SSE event:error
    end
    SM-->>BE: event:done
    FE->>User: æ¸²æŸ“å›¾è¡¨
```



### 3.2 SSE äº‹ä»¶ç±»å‹ï¼ˆ7 ç§ï¼‰


| äº‹ä»¶           | æ•°æ®æ ¼å¼                                                                        | è¯´æ˜                     |
| ------------ | --------------------------------------------------------------------------- | ---------------------- |
| `state`      | `{"state": "schema_retrieval                                                | llm_generation         |
| `thought`    | `{"content": "...", "done": false                                           | true}`                 |
| `sql`        | `{"content": "å®‰å…¨SQL", "raw": "åŸå§‹SQL"}`                                      | ç»é˜²ç«å¢™æ ¡éªŒåçš„ SQL           |
| `data`       | `{"columns": [...], "rows": [...], "row_count": N, "execution_time_ms": N}` | æŸ¥è¯¢ç»“æœæ•°æ®                 |
| `viz_config` | `{ECharts option å¯¹è±¡}`                                                       | å·²ç”¨å®é™…æ•°æ®å¡«å……çš„å®Œæ•´ ECharts é…ç½® |
| `error`      | `{"code": "...", "message": "..."}`                                         | é”™è¯¯ä¿¡æ¯                   |
| `done`       | `{"message": "æŸ¥è¯¢å®Œæˆ"}`                                                       | æŸ¥è¯¢æµç¨‹ç»“æŸ                 |


### 3.3 çŠ¶æ€æœºè®¾è®¡

```mermaid
stateDiagram-v2
    [*] --> SchemaRetrieval: ç”¨æˆ·æé—®
    SchemaRetrieval --> LLMGeneration: è·å¾—Top-K Schemaä¸Šä¸‹æ–‡
    LLMGeneration --> SQLValidation: æµå¼è¾“å‡ºå®Œæˆ,è§£æå‡ºSQL+VizConfig
    SQLValidation --> SQLExecution: æ ¡éªŒé€šè¿‡(è‡ªåŠ¨æ·»åŠ LIMIT)
    SQLValidation --> LLMGeneration: æ ¡éªŒå¤±è´¥_é‡è¯•<=3
    SQLValidation --> Error: é‡è¯•è¶…é™
    SQLExecution --> ResultStreaming: æŸ¥è¯¢æˆåŠŸ
    SQLExecution --> Error: æŸ¥è¯¢è¶…æ—¶æˆ–å¼‚å¸¸
    ResultStreaming --> Completed: æ•°æ®+å›¾è¡¨æ¨é€å®Œæˆ
    Completed --> [*]
    Error --> [*]: è¿”å›é”™è¯¯äº‹ä»¶
```



---

## å››ã€å‰ç«¯ UI å¸ƒå±€è®¾è®¡

### 4.0 æ•´ä½“é¡µé¢ç»“æ„

é‡‡ç”¨ç»å…¸çš„**å·¦å³åˆ†æ  + é¡¶éƒ¨å¯¼èˆª**å¸ƒå±€ï¼Œé£æ ¼å‚è€ƒç°ä»£ AI æ•°æ®äº§å“ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [YIWUSONG] æ¾å“¥çš„æ™ºèƒ½æ•°æ®åˆ†æç³»ç»Ÿ â†ç‚¹å‡»è¿”å›é¦–é¡µ    [DB: å·²è¿æ¥ â—]  â”‚  â† é¡¶éƒ¨å¯¼èˆªæ  (56px)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            â”‚                                                     â”‚
â”‚  æŸ¥è¯¢å†å²   â”‚              ä¸»å†…å®¹åŒº (MainContent)                  â”‚
â”‚            â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ä»Šå¤©    â”‚â”‚  â”‚  ğŸ’­ æ€è€ƒè¿‡ç¨‹ (å¯æŠ˜å , æµå¼æ‰“å­—æœº)               â”‚   â”‚
â”‚  â”‚        â”‚â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”‚ â— è¿‘30å¤©â”‚â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   é”€å”®  â”‚â”‚  â”‚  ğŸ“ SQL æŸ¥è¯¢ (è¯­æ³•é«˜äº®, å¯æŠ˜å , å¯å¤åˆ¶)        â”‚   â”‚
â”‚  â”‚        â”‚â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”‚ â— ç”¨æˆ·  â”‚â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   åˆ†å¸ƒ  â”‚â”‚  â”‚  ğŸ“‹ æŸ¥è¯¢ç»“æœ (10è¡Œ/8.3ms, å¯æŠ˜å )             â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”‚ æ˜¨å¤©    â”‚â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚        â”‚â”‚  â”‚  ğŸ“Š æ•°æ®å¯è§†åŒ– (ECharts å›¾è¡¨)                  â”‚   â”‚
â”‚  â”‚ â— å•†å“  â”‚â”‚  â”‚  (è‡ªé€‚åº”å®½é«˜, ä¸»è§†è§‰ç„¦ç‚¹)                      â”‚   â”‚
â”‚  â”‚   æ’å  â”‚â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                                                     â”‚
â”‚            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚            â”‚  â”‚  ğŸ’¬ è¯·è¾“å…¥ä½ çš„æ•°æ®æŸ¥è¯¢é—®é¢˜...          [å‘é€]  â”‚   â”‚  â† è¾“å…¥æ¡† (åº•éƒ¨å›ºå®š)
â”‚            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
```

### 4.1 ç»„ä»¶æ‹†åˆ†ä¸èŒè´£


| ç»„ä»¶                  | æ–‡ä»¶                    | èŒè´£                                           |
| ------------------- | --------------------- | -------------------------------------------- |
| **Header**          | `Header.tsx`          | Logo + æ ‡é¢˜ï¼ˆå¯ç‚¹å‡»è¿”å›é¦–é¡µï¼‰+ DB è¿æ¥çŠ¶æ€ç¯ï¼ˆæ¯30sè½®è¯¢ /healthï¼‰ |
| **Sidebar**         | `Sidebar.tsx`         | æŒ‰æ—¥æœŸåˆ†ç»„çš„æŸ¥è¯¢å†å²åˆ—è¡¨ï¼Œç‚¹å‡»é‡æ–°æ‰§è¡Œï¼Œç§»åŠ¨ç«¯å¯æŠ˜å                    |
| **QueryInput**      | `QueryInput.tsx`      | åº•éƒ¨å›ºå®šè¾“å…¥æ¡† + 4 ä¸ªæ¨èé—®é¢˜ + Enterå‘é€ + Loadingç¦ç”¨æ€     |
| **ThinkingDisplay** | `ThinkingDisplay.tsx` | æ€è€ƒè¿‡ç¨‹æ‰“å­—æœºæ•ˆæœï¼Œå¯æŠ˜å ï¼Œæµå¼æŒ‡ç¤ºåŠ¨ç”»                         |
| **SqlPreview**      | `SqlPreview.tsx`      | SQL è¯­æ³•é«˜äº® (highlight.js) + å¤åˆ¶æŒ‰é’®ï¼Œå¯æŠ˜å            |
| **DataTable**       | `DataTable.tsx`       | æŸ¥è¯¢ç»“æœè¡¨æ ¼ï¼Œæ˜¾ç¤ºè¡Œæ•°/è€—æ—¶ï¼Œäº¤æ›¿è¡Œåº•è‰²ï¼Œæœ€å¤šå±•ç¤º100è¡Œ                |
| **EChartsRenderer** | `EChartsRenderer.tsx` | å£°æ˜å¼ ECharts æ¸²æŸ“ï¼Œé€ä¼  optionï¼ŒResizeObserver è‡ªé€‚åº”  |
| **ErrorDisplay**    | `ErrorDisplay.tsx`    | çº¢è‰²é”™è¯¯æç¤ºæ¡ï¼Œæ˜¾ç¤ºé”™è¯¯ç å’Œæè¿°                             |
| **Skeleton**        | `Skeleton.tsx`        | ä¸‰ç§éª¨æ¶å±ï¼ˆthinking / sql / chartï¼‰                |


### 4.2 æµå¼ UI çŠ¶æ€æµè½¬

```mermaid
stateDiagram-v2
    [*] --> Idle: é¡µé¢åŠ è½½ / ç‚¹å‡»Logoè¿”å›
    Idle --> Thinking: ç”¨æˆ·å‘é€é—®é¢˜
    Thinking --> ShowSQL: æ”¶åˆ°event_sql
    ShowSQL --> ShowChart: æ”¶åˆ°event_viz_config
    ShowChart --> Idle: ç‚¹å‡»Logoè¿”å›é¦–é¡µ
    Thinking --> ShowError: æ”¶åˆ°event_error
    ShowSQL --> ShowError: æ”¶åˆ°event_error
    ShowError --> Idle: ç”¨æˆ·å…³é—­é”™è¯¯ / ç‚¹å‡»Logo

    state Thinking {
        [*] --> StreamDelta: event_thought(done=false)
        StreamDelta --> StreamDelta: é€å­—è¿½åŠ 
        StreamDelta --> StreamDone: event_thought(done=true)
    }
```



### 4.3 å“åº”å¼è®¾è®¡

- **æ¡Œé¢ç«¯ (>1024px)**: å·¦å³åˆ†æ ï¼Œä¾§è¾¹æ å¸¸é©»
- **å¹³æ¿ç«¯ (768-1024px)**: ä¾§è¾¹æ é»˜è®¤æŠ˜å ï¼Œå¯é€šè¿‡æ±‰å ¡æŒ‰é’®å±•å¼€ï¼ˆoverlay æ¨¡å¼ï¼‰
- **ç§»åŠ¨ç«¯ (<768px)**: ä¾§è¾¹æ éšè—ï¼›è¾“å…¥æ¡†å æ»¡å®½åº¦ï¼›å›¾è¡¨åŒºé«˜åº¦å›ºå®š 300px

### 4.4 è§†è§‰é£æ ¼

- **è‰²è°ƒ**: æ·±è‰²ä¸»é¢˜ï¼ˆæš—ç°åº• `#0f172a` + ç™½è‰²æ–‡å­—ï¼‰
- **å­—ä½“**: ç³»ç»Ÿå­—ä½“æ ˆ + ä»£ç åŒºä½¿ç”¨ç­‰å®½å­—ä½“
- **å…³é”®è‰²**: ä¸»è‰²è°ƒè“è‰² `#4f46e5`ï¼›æˆåŠŸç»¿ `#22c55e`ï¼›é”™è¯¯çº¢ `#ef4444`ï¼›è­¦å‘Šé»„ `#f59e0b`
- **åŠ¨æ•ˆ**: æ€è€ƒåŒºæ‰“å­—æœºæ•ˆæœï¼›å›¾è¡¨æ·¡å…¥ï¼›åŒºå—æŠ˜å /å±•å¼€ç”¨ `transition` è¿‡æ¸¡

---

## äº”ã€å…³é”®æ¨¡å—è®¾è®¡

### 5.1 LLM Engine (`backend/app/core/llm_engine.py`)

- ä½¿ç”¨ `openai` Python SDKï¼ˆAsyncOpenAI å¼‚æ­¥å®¢æˆ·ç«¯ï¼‰
- é…ç½®ï¼š`base_url=https://yunwu.ai/v1`ã€`model=gpt-5.2-chat`
- æµå¼æ¨¡å¼ï¼š`stream=True` é€ token æ¥æ”¶ï¼Œå®æ—¶æ¨é€ `thought` delta äº‹ä»¶
- éæµå¼æ¨¡å¼ï¼šä¸€æ¬¡æ€§è·å–å®Œæ•´å“åº”
- JSON è§£æå™¨ï¼šä¸‰çº§å›é€€ç­–ç•¥
  1. ç›´æ¥ `json.loads()` è§£æ
  2. æå– `json ...`  ä»£ç å—
  3. æå–ç¬¬ä¸€ä¸ª `{ ... }` å—
- System Prompt å¼ºåˆ¶è¾“å‡º JSON æ ¼å¼ï¼š`{"thinking": "...", "sql": "...", "echarts_option": {...}}`

### 5.2 Schema RAG (`backend/app/rag/`)

- **schema_extractor.py**: è¿æ¥ PG `information_schema` + `col_description()` + `obj_description()`ï¼Œæå–è¡¨åã€å­—æ®µåã€ç±»å‹ã€å¯ç©ºæ€§ã€æ³¨é‡Šã€å¤–é”®å…³ç³»
- **embedder.py**: ChromaDB å†…ç½® Embeddingï¼ˆall-MiniLM-L6-v2ï¼‰ï¼Œæ”¯æŒ upsert / reset / count
- **retriever.py**: æ¥æ”¶ç”¨æˆ·é—®é¢˜ï¼ŒChromaDB ä½™å¼¦ç›¸ä¼¼åº¦æ£€ç´¢ Top-5ï¼Œæ‹¼æ¥ä¸º LLM context æ–‡æœ¬
- **å¯åŠ¨æ—¶è‡ªåŠ¨ç´¢å¼•**: `main.py` lifespan ä¸­è°ƒç”¨ extractor â†’ embedderï¼Œæ„å»ºå‘é‡ç´¢å¼•

### 5.3 SQL é˜²ç«å¢™ (`backend/app/security/sql_firewall.py`)

- `sqlglot.parse(dialect="postgres")` è§£æ SQL ä¸º AST
- æ ¡éªŒè§„åˆ™ï¼š
  - æ ¹èŠ‚ç‚¹å¿…é¡»ä¸º `SELECT`ï¼ˆæ‹¦æˆª INSERT/UPDATE/DELETE/DROP/Create/Alterï¼‰
  - é€’å½’æ£€æŸ¥å­æŸ¥è¯¢ä¸­çš„å†™æ“ä½œ
  - ç¦æ­¢å±é™©å‡½æ•°ï¼ˆpg_sleep / dblink / lo_import ç­‰ï¼‰
  - è‡ªåŠ¨æ·»åŠ  `LIMIT`ï¼ˆé»˜è®¤ 1000ï¼Œè¶…å‡ºä¸Šé™å¼ºåˆ¶è£å‰ªï¼‰
- è¾“å‡ºï¼šè¿”å›ç» sqlglot é‡æ–°ç”Ÿæˆçš„å®‰å…¨ SQLï¼ˆdialect=postgresï¼‰
- æµ‹è¯•è¦†ç›–ï¼š12 é¡¹ pytest å…¨éƒ¨é€šè¿‡

### 5.4 æŸ¥è¯¢çŠ¶æ€æœº (`backend/app/core/state_machine.py`)

- 5 é˜¶æ®µç¼–æ’ï¼šSchemaRetrieval â†’ LLMGeneration â†’ SQLValidation â†’ SQLExecution â†’ ResultStreaming
- é€Ÿç‡é™åˆ¶ï¼šæ»‘åŠ¨çª—å£ï¼ˆæ¯åˆ†é’Ÿ 30 æ¬¡ï¼‰
- SQL æ ¡éªŒé‡è¯•ï¼šæœ€å¤š 3 æ¬¡
- æŸ¥è¯¢è¶…æ—¶ï¼š30 ç§’
- ECharts æ•°æ®å¡«å……ï¼šè‡ªåŠ¨å°†æŸ¥è¯¢ç»“æœå¡«å…¥ option çš„ xAxis.data / series[].dataï¼Œæ”¯æŒé¥¼å›¾ name/value æ ¼å¼

### 5.5 Mock æ¨¡å¼ (`POST /api/query/mock`)

åç«¯ Mock æ ¹æ®é—®é¢˜å…³é”®è¯æ™ºèƒ½åŒ¹é… 4 ç§åœºæ™¯ï¼š


| å…³é”®è¯            | åœºæ™¯         | å›¾è¡¨ç±»å‹          |
| -------------- | ---------- | ------------- |
| åŸå¸‚ / ç”¨æˆ·åˆ†å¸ƒ / åœ°åŒº | å„åŸå¸‚ç”¨æˆ·åˆ†å¸ƒ    | æŸ±çŠ¶å›¾ï¼ˆ10åŸå¸‚ï¼‰     |
| çƒ­é”€ / TOP / æ’è¡Œ  | çƒ­é”€å•†å“ TOP10 | æ¨ªå‘æ¡å½¢å›¾         |
| çŠ¶æ€ / è®¢å•ç»Ÿè®¡      | è®¢å•çŠ¶æ€ç»Ÿè®¡     | é¥¼å›¾ï¼ˆç¯å½¢ï¼‰        |
| å…¶ä»–ï¼ˆé»˜è®¤ï¼‰         | è¿‘30å¤©é”€å”®è¶‹åŠ¿   | æŸ±çŠ¶å›¾ + æŠ˜çº¿å›¾ï¼ˆåŒè½´ï¼‰ |


### 5.6 å‰ç«¯ SSE Hook (`frontend/src/hooks/useSSE.ts`)

- å‘èµ·æŸ¥è¯¢å‰å…ˆè°ƒ `/health` æ£€æŸ¥ DB çŠ¶æ€
  - DB å¯ç”¨ â†’ `POST /api/query`ï¼ˆçœŸå®é“¾è·¯ï¼‰
  - DB ä¸å¯ç”¨ â†’ `POST /api/query/mock`ï¼ˆè‡ªåŠ¨é™çº§ï¼‰
- ä½¿ç”¨ `fetch` + `ReadableStream`ï¼ˆæ”¯æŒ POST è¯·æ±‚ä½“ï¼‰
- è§£æ SSE åè®®ï¼ŒæŒ‰ `event:` å­—æ®µåˆ†å‘ï¼š
  - `thought` (delta/done) â†’ å¢é‡æ‹¼æ¥æ€è€ƒå†…å®¹
  - `sql` â†’ å±•ç¤ºå®‰å…¨ SQL
  - `data` â†’ å±•ç¤ºæŸ¥è¯¢ç»“æœè¡¨æ ¼
  - `viz_config` â†’ æ¸²æŸ“ ECharts å›¾è¡¨
  - `error` â†’ æ˜¾ç¤ºé”™è¯¯
- `USE_MOCK` å¼€å…³ï¼šå¯å¼ºåˆ¶ä½¿ç”¨å‰ç«¯å†…ç½® Mockï¼ˆä¸èµ°åç«¯ï¼‰

---

## å…­ã€æ¼”ç¤ºæ•°æ®åº“è®¾è®¡ (`database/init.sql`)

ç”µå•†åœºæ™¯ï¼ŒåŒ…å« 5 å¼ è¡¨ï¼ˆå‡å«å®Œæ•´ä¸­æ–‡å­—æ®µæ³¨é‡Šï¼‰ï¼š


| è¡¨å            | è¯´æ˜                 | æ•°æ®é‡       |
| ------------- | ------------------ | --------- |
| `categories`  | å•†å“åˆ†ç±»ï¼ˆ2 çº§ï¼Œå«çˆ¶å­å…³ç³»ï¼‰    | 13 æ¡      |
| `users`       | ç”¨æˆ·è¡¨ï¼ˆå§“åã€é‚®ç®±ã€åŸå¸‚ã€æ³¨å†Œæ—¶é—´ï¼‰ | 500 æ¡     |
| `products`    | å•†å“è¡¨ï¼ˆåç§°ã€åˆ†ç±»ã€ä»·æ ¼ã€åº“å­˜ï¼‰   | 200 æ¡     |
| `orders`      | è®¢å•è¡¨ï¼ˆç”¨æˆ·ã€é‡‘é¢ã€çŠ¶æ€ã€æ—¶é—´ï¼‰   | 5,000 æ¡   |
| `order_items` | è®¢å•æ˜ç»†ï¼ˆè®¢å•ã€å•†å“ã€æ•°é‡ã€å•ä»·ï¼‰  | ~10,000 æ¡ |


ç”¨æˆ·åˆ†å¸ƒåœ¨ 10 ä¸ªåŸå¸‚ï¼Œè®¢å•è¦†ç›–è¿‘ 12 ä¸ªæœˆï¼Œæ”¯æŒè¶‹åŠ¿åˆ†æã€æ’åã€åˆ†å¸ƒç­‰å¸¸è§æŸ¥è¯¢åœºæ™¯ã€‚

åˆ›å»º `readonly_user` åªè¯»ç”¨æˆ·å¹¶æˆæƒ `SELECT` æƒé™ã€‚

---

## ä¸ƒã€é…ç½®ç®¡ç†

### ç¯å¢ƒå˜é‡ (`.env`)

```
# LLM
OPENAI_API_BASE=https://yunwu.ai/v1
OPENAI_API_KEY=sk-xxx
OPENAI_MODEL=gpt-5.2-chat

# PostgreSQL
DATABASE_URL=postgresql+asyncpg://readonly_user:password@localhost:5432/demo_ecommerce

# ChromaDB
CHROMA_PERSIST_DIR=./chroma_data

# Server
BACKEND_HOST=0.0.0.0
BACKEND_PORT=8000
```

### Vite ä»£ç† (`vite.config.ts`)

- `/api/*` â†’ `http://localhost:8000`
- `/health` â†’ `http://localhost:8000`

---

## å…«ã€å®æ–½é˜¶æ®µ (4 Phase) â€” å…¨éƒ¨å·²å®Œæˆ âœ…

### Phase 1: æ­å»ºå‰åç«¯åŸºç¡€æ¡†æ¶ + è¿è¡Œæµ‹è¯• âœ…

> ç›®æ ‡ï¼šå‰åç«¯é¡¹ç›®èƒ½ç‹¬ç«‹è·‘èµ·æ¥ï¼Œæ•°æ®åº“å¯è¿æ¥ï¼Œç¡®è®¤åŸºç¡€è®¾æ–½æ­£å¸¸ã€‚

- âœ… **P1.1 åç«¯è„šæ‰‹æ¶**: FastAPI é¡¹ç›®ç»“æ„ (main.py / config.py / routes/)ã€`GET /health`
- âœ… **P1.2 å‰ç«¯è„šæ‰‹æ¶**: React + TypeScript + Tailwind CSS + ECharts + highlight.js
- âœ… **P1.3 æ•°æ®åº“ä¸å®¹å™¨åŒ–**: init.sql (5 è¡¨ + ä¸‡æ¡æ•°æ®)ã€docker-compose.ymlã€.env.example
- âœ… **P1.4 éªŒè¯è¿è¡Œ**: åç«¯ /health 200ã€å‰ç«¯é¡µé¢å¯è®¿é—®ã€Mock SSE éªŒè¯

### Phase 2: ç ”å‘å‰ç«¯ UI âœ…

> ç›®æ ‡ï¼šå‰ç«¯æ‰€æœ‰é¡µé¢å’Œç»„ä»¶å¼€å‘å®Œæˆï¼Œä½¿ç”¨ Mock æ•°æ®éªŒè¯ UI æ•ˆæœã€‚

- âœ… **P2.1 å¸ƒå±€æ¡†æ¶**: Header + Sidebar + MainContent å·¦å³åˆ†æ 
- âœ… **P2.2 QueryInput ç»„ä»¶**: åº•éƒ¨è¾“å…¥æ¡† + 4 ä¸ªæ¨èé—®é¢˜ + Enter å‘é€
- âœ… **P2.3 ç»“æœå±•ç¤ºç»„ä»¶**: ThinkingDisplay + SqlPreview + DataTable + EChartsRenderer + ErrorDisplay + Skeleton
- âœ… **P2.4 SSE Hook + çŠ¶æ€æµè½¬**: useSSE.ts + UI çŠ¶æ€æœº + éª¨æ¶å±
- âœ… **P2.5 å“åº”å¼ + ä¸»é¢˜**: æ·±è‰²ä¸»é¢˜ + ä¸‰æ¡£æ–­ç‚¹ + åŠ¨æ•ˆ

### Phase 3: ç ”å‘åç«¯æ¥å£ âœ…

> ç›®æ ‡ï¼šæ‰€æœ‰åç«¯ API å¼€å‘å®Œæˆï¼Œå¯ç”¨ curl ç‹¬ç«‹æµ‹è¯•æ¯ä¸ªæ¥å£ã€‚

- âœ… **P3.1 Schema RAG**: schema_extractor (è¡¨ç»“æ„+æ³¨é‡Š+å¤–é”®) + embedder (ChromaDB) + retriever (Top-K)
- âœ… **P3.2 LLM Engine**: gpt-5.2-chat æµå¼è°ƒç”¨ + ä¸‰çº§ JSON è§£æå›é€€
- âœ… **P3.3 å®‰å…¨å±‚**: SQL é˜²ç«å¢™ (12 é¡¹æµ‹è¯•é€šè¿‡) + query_limiter (è¶…æ—¶+é€Ÿç‡) + åªè¯»è¿æ¥æ± 
- âœ… **P3.4 æ ¸å¿ƒæŸ¥è¯¢æ¥å£**: POST /api/query SSE + çŠ¶æ€æœº + Mock 4 åœºæ™¯
- âœ… **P3.5 Schema ç®¡ç†**: status + refresh + tables ä¸‰ä¸ªç«¯ç‚¹
- âœ… **P3.6 ç‹¬ç«‹éªŒè¯**: 13 é¡¹ pytest å…¨éƒ¨é€šè¿‡ + curl SSE æµéªŒè¯

### Phase 4: å‰åç«¯è”è°ƒ âœ…

> ç›®æ ‡ï¼šå‰åç«¯å¯¹æ¥ï¼Œå®Œæˆç«¯åˆ°ç«¯å…¨æµç¨‹éªŒè¯ï¼Œç³»ç»Ÿå¯ç”¨äºæ¼”ç¤ºã€‚

- âœ… **P4.1 å‰åç«¯è”è°ƒ**: SSE Hook å¯¹æ¥ 7 ç§äº‹ä»¶ç±»å‹ã€DB å¥åº·æ£€æµ‹è‡ªåŠ¨é™çº§
- âœ… **P4.2 ç«¯åˆ°ç«¯æµ‹è¯•**: å‰ç«¯ä»£ç†éªŒè¯ã€Mock SSE å…¨æµç¨‹ã€curl ç‹¬ç«‹æµ‹è¯•
- âœ… **P4.3 ä¼˜åŒ–æ”¶å°¾**: Docker Compose ä¸‰æœåŠ¡ã€Dockerfileã€nginx SSE ä»£ç†ã€Header è¿”å›é¦–é¡µ

---

## ä¹ã€å¯åŠ¨æŒ‡å—

### å¼€å‘æ¨¡å¼ï¼ˆæ—  Dockerï¼‰

```bash
# åç«¯
cd backend
python3 -m venv venv && source venv/bin/activate
pip install -r requirements.txt
uvicorn app.main:app --host 0.0.0.0 --port 8000

# å‰ç«¯
cd frontend
npm install && npm run dev
```

è®¿é—® `http://localhost:3000`ï¼ŒDB ä¸å¯ç”¨æ—¶è‡ªåŠ¨ä½¿ç”¨ Mock æ¨¡å¼ã€‚

### Docker å…¨æ ˆéƒ¨ç½²

```bash
docker-compose up -d
# postgres: 5432, backend: 8000, frontend: 3000
```

